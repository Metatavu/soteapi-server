<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
  <changeSet author="Heikki Kurhinen" id="20171013-contents-initial-database">
    <createTable tableName="content">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="originId" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="slug" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="contentType" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="parent_id" type="BIGINT">
        <constraints nullable="true"/>
      </column>
    </createTable>

    <createIndex indexName="I-CONTENT-SLUG" tableName="content">
      <column name="slug"/>
    </createIndex>

    <createIndex indexName="I-CONTENT-ORIGIN-ID" tableName="content">
      <column name="originId"/>
    </createIndex>

    <createTable tableName="contenttitle">
      <column autoIncrement="true" name="id" type="BIGINT">
          <constraints primaryKey="true"/>
      </column>
      <column name="content_id" type="BIGINT">
          <constraints nullable="false"/>
      </column>
      <column name="language" type="VARCHAR(255)">
          <constraints nullable="false"/>
      </column>
      <column name="value" type="LONGTEXT">
          <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="I-CONTENTTITLE-CONTENTID" tableName="contenttitle">
      <column name="content_id"/>
    </createIndex>

    <addForeignKeyConstraint baseColumnNames="content_id" baseTableName="contenttitle" constraintName="FK-CONTENTTITLE-CONTENT-ID" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="content"/>

    <createTable tableName="contentdata">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="content_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="language" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="value" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="I-CONTENTDATA-CONTENTID" tableName="contentdata">
      <column name="content_id"/>
    </createIndex>

    <addForeignKeyConstraint baseColumnNames="content_id" baseTableName="contentdata" constraintName="FK-CONTENTDATA-CONTENT-ID" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="content"/>

    <createTable tableName="contentimagemeta">
      <column name="id" type="bigint(20)" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="content_id" type="BIGINT">
          <constraints nullable="false"/>
      </column>
      <column name="name" type="varchar(255)" />
      <column name="type" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="contentType" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="I-CONTENTIMAGE-CONTENTID" tableName="contentimagemeta">
      <column name="content_id"/>
    </createIndex>

    <addForeignKeyConstraint baseColumnNames="content_id" baseTableName="contentimagemeta" constraintName="FK-CONTENTIMAGE-CONTENT-ID" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="content"/>

    <createTable tableName="contentimagedata">
      <column name="id" type="bigint(20)" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="contentimagemeta_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="data" type="longblob">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex tableName="contentimagedata" indexName="I-CONTENTIMAGEDATA-CONTENTIMAGEMETA-ID" unique="true">
      <column name="contentimagemeta_id"/>
    </createIndex>

    <addForeignKeyConstraint baseColumnNames="contentimagemeta_id" baseTableName="contentimagedata" constraintName="FK-CONTENTIMAGEDATA-CONTENTIMAGEMETA-ID" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="contentimagemeta"/>

  </changeSet>
  
  <changeSet author="Heikki Kurhinen" id="20171013-taskmodel-taskqueue">
    <createTable tableName="taskmodel">
	    <column autoIncrement="true" name="id" type="BIGINT">
	       <constraints primaryKey="true"/>
	    </column>
	    <column name="created" type="datetime(6)">
	       <constraints nullable="false"/>
	    </column>
	    <column name="data" type="LONGBLOB">
	       <constraints nullable="false"/>
	    </column>
	    <column name="priority" type="BIT(1)">
	       <constraints nullable="false"/>
	    </column>
	    <column name="uniqueId" type="VARCHAR(255)">
	       <constraints nullable="false"/>
	    </column>
	    <column name="queue_id" type="BIGINT"/>
    </createTable>

    <createTable tableName="taskqueue">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="lastTaskReturned" type="datetime(6)"/>
      <column name="name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="responsibleNode" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseColumnNames="queue_id" baseTableName="taskmodel" constraintName="FK-TASKMODEL-TASKQUEUE-ID" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="taskqueue"/>
    
  </changeSet>
  
  <changeSet id="taskqueue-name-unique-constraint" author="Heikki Kurhinen">
    <addUniqueConstraint columnNames="name" tableName="taskqueue" constraintName="UN-TASKQUEUE-NAME"/>
  </changeSet>
  
  <changeSet id="content-add-category" author="Heikki Kurhinen">
	  <addColumn tableName="content">
	    <column name="category" type="VARCHAR(255)" />
	  </addColumn>
  </changeSet>
  
  <changeSet id="category-categorytitle-create" author="Heikki Kurhinen">
    <createTable tableName="category">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="originId" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="slug" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="I-CATEGORY-SLUG" tableName="category">
      <column name="slug"/>
    </createIndex>

    <createIndex indexName="I-CATEGORY-ORIGIN-ID" tableName="category">
      <column name="originId"/>
    </createIndex>

    <createTable tableName="categorytitle">
      <column autoIncrement="true" name="id" type="BIGINT">
          <constraints primaryKey="true"/>
      </column>
      <column name="category_id" type="BIGINT">
          <constraints nullable="false"/>
      </column>
      <column name="language" type="VARCHAR(255)">
          <constraints nullable="false"/>
      </column>
      <column name="value" type="LONGTEXT">
          <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="I-CATEGORYTITLE-CATEGORYID" tableName="categorytitle">
      <column name="category_id"/>
    </createIndex>

    <addForeignKeyConstraint baseColumnNames="category_id" baseTableName="categorytitle" constraintName="FK-CATEGORYTITLE-CATEGORY-ID" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="category"/>
  </changeSet>
  
</databaseChangeLog>



